<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reef Chemistry Logger</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --muted:#9fb2ff; --ink:#e9eefc; --accent:#7aa2ff; --accent2:#25d0a6; --warn:#ffb02e; --danger:#ff5a78; --ok:#21d19f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"PingFang TC","Noto Sans TC","Microsoft JhengHei",Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    h1{margin:0 0 12px;font-size:clamp(22px,3.5vw,36px)}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border-radius:18px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .grid{display:grid;gap:12px}
    .grid.cols-6{grid-template-columns:repeat(6,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-6{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-6{grid-template-columns:repeat(2,minmax(0,1fr))}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,button,select{font:inherit}
    input[type="date"], select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1f2a4d;background:#0f1733;color:var(--ink);outline:none}
    select:focus,input:focus{border-color:var(--accent)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#081126}
    .btn.ghost{background:transparent;border:1px solid #223061;color:var(--ink)}
    .btn.warn{background:var(--warn);color:#2b1600}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px}
    thead th{font-size:12px;color:var(--muted)}
    tbody tr{background:#0f1733}
    tbody td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .hint{font-size:11px;color:#bcd0ff;opacity:.85}
    footer{margin-top:18px;color:#94a8ff;font-size:12px;opacity:.8}
    .right{margin-left:auto}
    details.dev summary{cursor:pointer}
    .dev-pass{color:#21d19f}
    .dev-fail{color:#ff5a78}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="align-items:center">
      <div>
        <h1>Reef Chemistry Logger</h1>
        <div class="muted">Track NO‚ÇÉ, PO‚ÇÑ, KH, Ca, Mg ‚Äî saved locally in your browser.</div>
      </div>
      <div class="right toolbar">
        <button class="btn ghost" id="exportBtn" title="Export CSV">Export CSV</button>
        <label for="importInput" class="btn ghost" style="cursor:pointer" title="Import CSV">Import CSV</label>
        <input id="importInput" type="file" accept=".csv" style="display:none" />
        <button class="btn ghost" id="clearAllBtn" title="Clear data">Clear All</button>
      </div>
    </header>

    <section class="panel" style="margin-top:16px">
      <form id="entryForm" class="grid cols-6" autocomplete="off">
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" name="date" required />
          <div class="hint">Default = today (local time)</div>
        </div>
        <div>
          <label for="no3">NO‚ÇÉ (ppm)</label>
          <select id="no3" name="no3">
            <option value="">‚Äî</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2.5">2.5</option>
            <option value="10">10</option>
            <option value=">10">&gt;10</option>
          </select>
        </div>
        <div>
          <label for="po4">PO‚ÇÑ (ppm)</label>
          <select id="po4" name="po4">
            <option value="">‚Äî</option>
            <option value="0">0</option>
            <option value="0.03">0.03</option>
            <option value="0.1">0.1</option>
            <option value="0.25">0.25</option>
            <option value="0.5">0.5</option>
            <option value="1">1</option>
            <option value="3">3</option>
          </select>
        </div>
        <div>
          <label for="kh">KH (dKH)</label>
          <select id="kh" name="kh">
            <option value="">‚Äî</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
          </select>
        </div>
        <div>
          <label for="ca">Ca (ppm)</label>
          <input type="number" id="ca" name="ca" inputmode="numeric" step="1" min="0" placeholder="e.g. 430" />
        </div>
        <div>
          <label for="mg">Mg (ppm)</label>
          <input type="number" id="mg" name="mg" inputmode="numeric" step="1" min="0" placeholder="e.g. 1350" />
        </div>
        <div class="row" style="grid-column:1/-1;justify-content:flex-end;margin-top:6px">
          <button type="button" class="btn ghost" id="resetBtn">Reset</button>
          <button type="submit" class="btn primary" id="saveBtn">Save</button>
          <button type="button" class="btn warn" id="saveAndNotesBtn" title="Save and send to iPhone Notes via Shortcut">Save ‚Üí Notes</button>
        </div>
      </form>
      <div id="warnBox" style="margin-top:8px"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <div class="row" style="align-items:center; margin-bottom:8px">
        <strong>Log</strong>
        <div class="right toolbar">
          <select id="sortSelect" title="Sort order">
            <option value="desc">Newest first</option>
            <option value="asc">Oldest first</option>
          </select>
          <input type="text" id="search" placeholder="Search date or value‚Ä¶" />
        </div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>NO‚ÇÉ</th><th>PO‚ÇÑ</th><th>KH</th><th>Ca</th><th>Mg</th><th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn warn" id="sendLatestBtn" title="Send the newest log row to iPhone Notes via Shortcut">Send Latest ‚Üí Notes</button>
      </div>
    </section>

    <details class="panel dev" style="margin-top:16px">
      <summary>üîß Self‚Äëtests</summary>
      <div id="tests"></div>
      <div class="hint">These run in your browser to catch common issues (missing elements, newline handling, etc.).</div>
    </details>

    <footer>
      Pro tip: Click ‚úé to edit a row. Data is stored in <code>localStorage</code> (this browser only).
    </footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const pad = n => String(n).padStart(2,'0');
    const todayLocalISO = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
    const toNumber = v => (v===undefined||v===null||v==='') ? null : (Number.isFinite(Number(v)) ? Number(v) : null);

    // ---------- Storage ----------
    const KEY = 'reefChemEntries.v1';
    const load = () => { try { return JSON.parse(localStorage.getItem(KEY))||[] } catch { return [] } };
    const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

    // ---------- State ----------
    let entries = load();
    let editingId = null;
    let pendingShortcut = false;

    // ---------- DOM ----------
    const form = $('#entryForm');
    const tbody = $('#tbody');
    const sortSelect = $('#sortSelect');
    const search = $('#search');
    const resetBtn = $('#resetBtn');
    const saveAndNotesBtn = $('#saveAndNotesBtn');
    const sendLatestBtn = $('#sendLatestBtn');
    const exportBtn = $('#exportBtn');
    const importInput = $('#importInput');
    const clearAllBtn = $('#clearAllBtn');
    const testsDiv = $('#tests');

    // Init date
    $('#date').value = todayLocalISO();

    // ---------- iOS Shortcuts helpers ----------
    function openShortcutWithText(text){
      const shortcutName = 'SaveToReefTankData';
      const url = `shortcuts://run-shortcut?name=${encodeURIComponent(shortcutName)}&input=text&text=${encodeURIComponent(text)}`;
      window.location.href = url; // iOS Safari will switch to Shortcuts
    }
    function formatEntryForNotes({date,no3,po4,kh,ca,mg}){
      const v = x => (x===undefined || x===null || x==='') ? '-' : x;
      return `Reef Log ‚Äî ${date}\nNO3: ${v(no3)}\nPO4: ${v(po4)}\nKH: ${v(kh)}\nCa: ${v(ca)}\nMg: ${v(mg)}`;
    }

    // ---------- Submit (Save) ----------
    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());

      // Capture display strings BEFORE normalization (keep ">10")
      const displayEntry = {
        date: data.date || todayLocalISO(),
        no3: data.no3 || '',
        po4: data.po4 || '',
        kh: data.kh || '',
        ca: data.ca || '',
        mg: data.mg || ''
      };

      // Normalize for storage (strip '>')
      const entry = {
        id: editingId || uid(),
        date: displayEntry.date,
        no3: toNumber((data.no3||'').replace('>','')),
        po4: toNumber(data.po4),
        kh: toNumber(data.kh),
        ca: toNumber(data.ca),
        mg: toNumber(data.mg),
        // keep display copies for rendering/export
        no3Disp: displayEntry.no3 || null,
        po4Disp: displayEntry.po4 || null,
        khDisp: displayEntry.kh || null,
        createdAt: editingId ? (entries.find(x=>x.id===editingId)?.createdAt || Date.now()) : Date.now(),
        updatedAt: Date.now()
      };

      if(editingId){
        entries = entries.map(e=> e.id===editingId ? entry : e);
      } else {
        entries.push(entry);
      }
      save(entries);
      render();

      if(pendingShortcut){
        pendingShortcut = false;
        const text = formatEntryForNotes(displayEntry);
        setTimeout(()=> openShortcutWithText(text), 30);
      }

      form.reset();
      $('#date').value = todayLocalISO();
      editingId = null;
      $('#saveBtn').textContent = 'Save';
    });

    // Save ‚Üí Notes triggers submit then opens Shortcuts with the captured values
    if (saveAndNotesBtn) {
      saveAndNotesBtn.addEventListener('click', ()=>{ pendingShortcut = true; form.requestSubmit(); });
    }

    // Reset
    if (resetBtn) {
      resetBtn.addEventListener('click', ()=>{
        form.reset();
        $('#date').value = todayLocalISO();
        editingId = null;
        $('#saveBtn').textContent = 'Save';
      });
    }

    // Clear all
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', ()=>{
        if(confirm('Delete ALL entries?')){ entries = []; save(entries); render(); }
      });
    }

    // Send newest row to Notes (button under the table)
    if (sendLatestBtn) {
      sendLatestBtn.addEventListener('click', ()=>{
        if(!entries.length){ alert('No rows yet. Save one first.'); return; }
        const newest = [...entries].sort((a,b)=> b.date.localeCompare(a.date))[0];
        const text = formatEntryForNotes({
          date: newest.date,
          no3: newest.no3Disp ?? newest.no3 ?? '',
          po4: newest.po4Disp ?? newest.po4 ?? '',
          kh: newest.khDisp ?? newest.kh ?? '',
          ca: newest.ca ?? '',
          mg: newest.mg ?? ''
        });
        openShortcutWithText(text);
      });
    }

    // ---------- Table rendering ----------
    sortSelect.addEventListener('change', render);
    search.addEventListener('input', render);

    function render(){
      const term = search.value.trim().toLowerCase();
      const sorted = [...entries].sort((a,b)=> sortSelect.value==='asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date));
      const filtered = term ? sorted.filter(e=> JSON.stringify(e).toLowerCase().includes(term)) : sorted;
      tbody.innerHTML = filtered.map(e=> rowHTML(e)).join('');
      // Wire row buttons
      $$('#tbody button[data-id]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          const e = entries.find(x=>x.id===id);
          if(!e) return;
          if(action==='edit'){
            editingId = id;
            $('#date').value = e.date;
            $('#no3').value = (e.no3Disp ?? e.no3 ?? '').toString();
            $('#po4').value = (e.po4Disp ?? e.po4 ?? '').toString();
            $('#kh').value = (e.khDisp ?? e.kh ?? '').toString();
            $('#ca').value = (e.ca ?? '').toString();
            $('#mg').value = (e.mg ?? '').toString();
            $('#saveBtn').textContent = 'Update';
            window.scrollTo({top:0,behavior:'smooth'});
          } else if(action==='delete'){
            if(confirm('Delete this entry?')){ entries = entries.filter(x=>x.id!==id); save(entries); render(); }
          }
        });
      });
    }

    function rowHTML(e){
      const v = (raw,num)=> (raw ?? num ?? '‚Äî');
      return `<tr>
        <td>${e.date}</td>
        <td>${v(e.no3Disp, e.no3)}</td>
        <td>${v(e.po4Disp, e.po4)}</td>
        <td>${v(e.khDisp, e.kh)}</td>
        <td>${e.ca ?? '‚Äî'}</td>
        <td>${e.mg ?? '‚Äî'}</td>
        <td style="text-align:right">
          <button class="btn ghost" data-action="edit" data-id="${e.id}" title="Edit">‚úé</button>
          <button class="btn ghost" data-action="delete" data-id="${e.id}" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    }

    // ---------- Export / Import (CSV) ----------
    function toCSV(rows){
      const header = ['date','no3','po4','kh','ca','mg','no3Disp','po4Disp','khDisp'];
      const lines = [header.join(',')];
      rows.forEach(e=>{
        lines.push([
          e.date,
          e.no3 ?? '', e.po4 ?? '', e.kh ?? '', e.ca ?? '', e.mg ?? '',
          e.no3Disp ?? '', e.po4Disp ?? '', e.khDisp ?? ''
        ].join(','));
      });
      return lines.join('\n');
    }
    function download(filename, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }
    if(exportBtn){
      exportBtn.addEventListener('click', ()=>{
        const csv = toCSV(entries);
        const stamp = new Date().toISOString().slice(0,10);
        download(`reef-chemistry-${stamp}.csv`, csv);
      });
    }
    if(importInput){
      importInput.addEventListener('change', async (ev)=>{
        const file = ev.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        const [h, ...rest] = lines;
        const cols = h.split(',').map(s=>s.trim().toLowerCase());
        const idx = Object.fromEntries(cols.map((c,i)=>[c,i]));
        const get = (parts, key) => parts[idx[key]] ?? '';
        const imported = rest.map(line=>{
          const parts = line.split(',');
          return {
            id: uid(),
            date: (get(parts,'date')||'').slice(0,10),
            no3: toNumber((get(parts,'no3')||'').replace('>','')),
            po4: toNumber(get(parts,'po4')),
            kh: toNumber(get(parts,'kh')),
            ca: toNumber(get(parts,'ca')),
            mg: toNumber(get(parts,'mg')),
            no3Disp: get(parts,'no3disp') || null,
            po4Disp: get(parts,'po4disp') || null,
            khDisp: get(parts,'khdisp') || null,
            createdAt: Date.now(),
            updatedAt: Date.now()
          }
        }).filter(e=> e.date);
        if(!imported.length){ alert('No valid rows found.'); return; }
        if(!confirm(`Import ${imported.length} rows?`)) return;
        entries = entries.concat(imported);
        save(entries); render();
        ev.target.value = '';
      });
    }

    // ---------- Self tests ----------
    function runTests(){
      const results = [];
      const assert = (name, cond, msg='') => results.push({name, ok: !!cond, msg});

      // Elements exist
      const ids = ['entryForm','date','no3','po4','kh','ca','mg','resetBtn','saveBtn','saveAndNotesBtn','sortSelect','search','exportBtn','importInput','clearAllBtn','tbody','sendLatestBtn'];
      ids.forEach(id=> assert(`element #${id} exists`, !!document.getElementById(id), 'Missing DOM element'));

      // IDs are globally unique
      const allIds = [...document.querySelectorAll('[id]')].map(n=>n.id);
      const uniqueIds = new Set(allIds);
      assert('All IDs are unique', uniqueIds.size === allIds.length, `Duplicate IDs: ${allIds.filter((id,i)=> allIds.indexOf(id)!==i).join(', ')}`);

      // CSV newline test
      const sampleCSV = toCSV([{date:'2025-09-28', no3:1}]);
      assert('CSV contains newline', sampleCSV.includes('\n'));
      assert('CSV has at least 2 lines', sampleCSV.split('\n').length >= 2);

      // Import split handles CRLF and LF
      const testText = 'date,no3\r\n2025-09-28,1\n2025-09-29,2';
      const pieces = testText.split(/\r?\n/);
      assert('CRLF/LF split works', pieces.length === 3);

      // Shortcuts URL formed
      const urlOK = (()=>{
        const txt = formatEntryForNotes({date:'2025-09-28',no3:'>10',po4:'0.03',kh:'8',ca:'430',mg:'1350'});
        const name = 'SaveToReefTankData';
        const url = `shortcuts://run-shortcut?name=${encodeURIComponent(name)}&input=text&text=${encodeURIComponent(txt)}`;
        return url.startsWith('shortcuts://run-shortcut?');
      })();
      assert('Shortcuts URL generated', urlOK);

      // No duplicate critical IDs (explicit)
      const dupReset = document.querySelectorAll('#resetBtn').length;
      const dupSave = document.querySelectorAll('#saveBtn').length;
      assert('Unique #resetBtn', dupReset === 1, `Found ${dupReset}`);
      assert('Unique #saveBtn', dupSave === 1, `Found ${dupSave}`);

      // todayLocalISO format
      const t = todayLocalISO();
      assert('todayLocalISO format YYYY-MM-DD', /^\d{4}-\d{2}-\d{2}$/.test(t));

      // Storage round-trip (non-destructive)
      const prev = localStorage.getItem(KEY);
      try {
        const testRows = [{id:'t1', date:'2025-09-28', no3:1, po4:0.03, kh:8, ca:430, mg:1350}];
        save(testRows);
        const loaded = load();
        assert('storage round-trip works', Array.isArray(loaded) && loaded[0]?.date==='2025-09-28');
      } finally {
        if(prev===null) localStorage.removeItem(KEY); else localStorage.setItem(KEY, prev);
      }

      // Render should not throw
      try { render(); assert('Render executed', true); } catch(e){ assert('Render executed', false, e.message); }

      // Show results
      if(testsDiv){
        testsDiv.innerHTML = '<ul>'+results.map(r=>`<li class="${r.ok?'dev-pass':'dev-fail'}">${r.ok?'‚úì':'‚úó'} ${r.name}${r.msg?` ‚Äî ${r.msg}`:''}</li>`).join('')+'</ul>';
      }
      console.table(results);
      return results.every(r=>r.ok);
    }

    // First paint and tests
    render();
    runTests();
  </script>
</body>
</html>

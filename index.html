<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reef Chemistry Logger</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --muted:#9fb2ff; --ink:#e9eefc; --accent:#7aa2ff; --accent2:#25d0a6; --warn:#ffb02e; --danger:#ff5a78; --ok:#21d19f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"PingFang TC","Noto Sans TC","Microsoft JhengHei",Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%);color:var(--ink)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 12px;font-size:clamp(22px,3.5vw,34px)}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border-radius:18px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .grid{display:grid;gap:12px}
    .grid.cols-6{grid-template-columns:repeat(6,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-6{grid-template-columns:repeat(3,minmax(0,1fr))}.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-6,.grid.cols-3{grid-template-columns:repeat(1,minmax(0,1fr))}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,button,select{font:inherit}
    input[type="date"], select, input[type="number"], input[readonly]{width:100%;padding:12px;border-radius:12px;border:1px solid #1f2a4d;background:#0f1733;color:var(--ink);outline:none}
    select:focus,input:focus{border-color:var(--accent)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#081126}
    .btn.ghost{background:transparent;border:1px solid #223061;color:var(--ink)}
    .btn.warn{background:var(--warn);color:#2b1600}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:11px;color:#bcd0ff;opacity:.85}
    footer{margin-top:18px;color:#94a8ff;font-size:12px;opacity:.8}
    .right{margin-left:auto}
    details.dev summary{cursor:pointer}
    .dev-pass{color:#21d19f}
    .dev-fail{color:#ff5a78}

    /* Maintenance cards */
    .card{background:#0f1733;border:1px solid #223061;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:14px;color:#d7e3ff}
    .dose-row{display:flex;gap:8px;align-items:center}
    .dose-ctl{display:flex;gap:6px}
    .icon-btn{width:38px;height:38px;border-radius:10px;border:1px solid #223061;background:transparent;color:var(--ink);font-size:18px;line-height:1}
    .spacer{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="align-items:center">
      <div>
        <h1>Reef Chemistry Logger</h1>
        <div class="muted">Quickly record test values & maintenance actions. Notes are sent to your iPhone Shortcut.</div>
      </div>
      <div class="right toolbar">
        <button class="btn ghost" id="exportBtn" title="Export CSV">Export CSV</button>
        <label for="importInput" class="btn ghost" style="cursor:pointer" title="Import CSV">Import CSV</label>
        <input id="importInput" type="file" accept=".csv" style="display:none" />
        <button class="btn ghost" id="clearAllBtn" title="Clear saved entries in this browser">Clear All</button>
      </div>
    </header>

    <!-- Entry form (updated KH handling) -->
    <section class="panel" style="margin-top:16px">
      <form id="entryForm" class="grid cols-6" autocomplete="off">
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" name="date" required />
          <div class="hint">Default = today (local time)</div>
        </div>
        <div>
          <label for="no3">NO₃ (ppm)</label>
          <select id="no3" name="no3">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2.5">2.5</option>
            <option value="10">10</option>
            <option value=">10">&gt;10</option>
          </select>
        </div>
        <div>
          <label for="po4">PO₄ (ppm)</label>
          <select id="po4" name="po4">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="0.03">0.03</option>
            <option value="0.1">0.1</option>
            <option value="0.25">0.25</option>
            <option value="0.5">0.5</option>
            <option value="1">1</option>
            <option value="3">3</option>
          </select>
        </div>
        <!-- NEW: KH Reading (mL) scroll list 0.60–0.80 step 0.01 -->
        <div>
          <label for="khReading">KH Reading (mL)</label>
          <select id="khReading" name="khReading"></select>
          <div class="hint">Salifert reading 0.60–0.80 (step 0.01). Default 0.70.</div>
        </div>
        <!-- Replaced KH input with readonly computed dKH -->
        <div>
          <label for="khDkh">KH (dKH, auto)</label>
          <input id="khDkh" name="khDkh" type="number" step="0.1" readonly placeholder="auto" />
          <div class="hint">Computed from reading. Saved to log.</div>
        </div>
        <div>
          <label for="ca">Ca (ppm)</label>
          <input type="number" id="ca" name="ca" inputmode="numeric" step="1" min="0" placeholder="e.g. 430" />
        </div>
        <div>
          <label for="mg">Mg (ppm)</label>
          <input type="number" id="mg" name="mg" inputmode="numeric" step="1" min="0" placeholder="e.g. 1350" />
        </div>
        <div class="row" style="grid-column:1/-1;justify-content:flex-end;margin-top:6px">
          <button type="button" class="btn ghost" id="resetBtn">Reset</button>
          <button type="submit" class="btn primary" id="saveBtn">Save</button>
          <button type="button" class="btn warn" id="saveAndNotesBtn" title="Save and send to iPhone Notes via Shortcut">Save → Notes</button>
        </div>
      </form>
      <div id="warnBox" style="margin-top:8px"></div>
      <!-- Small live preview of KH×2 -->
      <div class="hint" id="khPreview" style="margin-top:6px">KH×2 (2 mL sample): —</div>
    </section>

    <!-- Maintenance -->
    <section class="panel" style="margin-top:16px">
      <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:6px">
        <strong>Maintenance</strong>
        <div class="hint">All actions send a two‑line record to your Shortcut <code>SaveToReefTankData</code>.</div>
      </div>

      <!-- Quick actions -->
      <div class="grid cols-3" style="margin-bottom:12px">
        <div class="card">
          <h3>Change Water</h3>
          <div class="dose-row">
            <div class="hint">Sends:</div>
            <div class="hint">D/M/YYYY + <code>#changewater</code></div>
            <div class="spacer"></div>
            <button type="button" class="btn primary" id="changeWaterBtn">Send</button>
          </div>
        </div>
        <div class="card">
          <h3>Send All Doses</h3>
          <div class="hint">Sends KH + Ca + Mg in one note</div>
          <div class="spacer"></div>
          <button type="button" class="btn ghost" id="sendAllDosesBtn">Send All → Notes</button>
        </div>
        <div class="card">
          <h3>Today</h3>
          <div class="hint">Uses the date field above; change it there if needed.</div>
        </div>
      </div>

      <!-- Dosing cards -->
      <div class="grid cols-3" style="margin-bottom:12px">
        <div class="card">
          <h3>KH Droplet (ml/day)</h3>
          <div class="dose-row">
            <div class="dose-ctl">
              <button type="button" class="icon-btn" id="khMinus" aria-label="Decrease">−</button>
              <button type="button" class="icon-btn" id="khZero" aria-label="Reset to 0">0</button>
              <button type="button" class="icon-btn" id="khPlus" aria-label="Increase">+</button>
            </div>
            <select id="khDose" style="max-width:120px"></select>
            <div class="spacer"></div>
            <button type="button" class="btn ghost" id="khDoseBtn">Send → Notes</button>
          </div>
          <div class="hint">Example: <code>23/9/2025</code> + <code>KH droplet at 2ml per day</code></div>
        </div>

        <div class="card">
          <h3>Ca Droplet (ml/day)</h3>
          <div class="dose-row">
            <div class="dose-ctl">
              <button type="button" class="icon-btn" id="caMinus" aria-label="Decrease">−</button>
              <button type="button" class="icon-btn" id="caZero" aria-label="Reset to 0">0</button>
              <button type="button" class="icon-btn" id="caPlus" aria-label="Increase">+</button>
            </div>
            <select id="caDose" style="max-width:120px"></select>
            <div class="spacer"></div>
            <button type="button" class="btn ghost" id="caDoseBtn">Send → Notes</button>
          </div>
        </div>

        <div class="card">
          <h3>Mg Droplet (ml/day)</h3>
          <div class="dose-row">
            <div class="dose-ctl">
              <button type="button" class="icon-btn" id="mgMinus" aria-label="Decrease">−</button>
              <button type="button" class="icon-btn" id="mgZero" aria-label="Reset to 0">0</button>
              <button type="button" class="icon-btn" id="mgPlus" aria-label="Increase">+</button>
            </div>
            <select id="mgDose" style="max-width:120px"></select>
            <div class="spacer"></div>
            <button type="button" class="btn ghost" id="mgDoseBtn">Send → Notes</button>
          </div>
        </div>
      </div>

      <!-- Other actions (NEW) -->
      <div class="grid cols-3">
        <div class="card">
          <h3>加魚糧（匙）</h3>
          <div class="dose-row">
            <div class="dose-ctl">
              <button type="button" class="icon-btn" id="foodMinus" aria-label="Decrease">−</button>
              <button type="button" class="icon-btn" id="foodZero" aria-label="Reset to 0">0</button>
              <button type="button" class="icon-btn" id="foodPlus" aria-label="Increase">+</button>
            </div>
            <select id="foodSpoons" style="max-width:120px"></select>
            <div class="spacer"></div>
            <button type="button" class="btn ghost" id="foodSendBtn">Send → Notes</button>
          </div>
          <div class="hint">格式：<code>D/M/YYYY</code> + <code>加魚糧 X 匙</code></div>
        </div>
        <div class="card">
          <h3>油膜</h3>
          <div class="dose-row">
            <div class="hint">Sends:</div>
            <div class="hint">D/M/YYYY + <code>水面有油膜</code></div>
            <div class="spacer"></div>
            <button type="button" class="btn primary" id="surfaceFilmBtn">Send</button>
          </div>
        </div>
        <div class="card">
          <h3>更換過濾棉</h3>
          <div class="dose-row">
            <div class="hint">Sends:</div>
            <div class="hint">D/M/YYYY + <code>更換過濾棉</code></div>
            <div class="spacer"></div>
            <button type="button" class="btn primary" id="filterFlossBtn">Send</button>
          </div>
          <div class="hint">（你之前常用「換綿」也可以，見腳本）</div>
        </div>
      </div>
    </section>

    <details class="panel dev" style="margin-top:16px">
      <summary>🔧 Self‑tests</summary>
      <div id="tests"></div>
      <div class="hint">These run in your browser to catch common issues (missing elements, newline handling, etc.).</div>
    </details>

    <footer>
      Data is stored in <code>localStorage</code> (this browser only). Export CSV to back up.
    </footer>
  </div>

  <script>
  // ---------- Utilities ----------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const pad = n => String(n).padStart(2,'0');
  const todayLocalISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const toNumber = v => (v===undefined||v===null||v==='') ? null : (Number.isFinite(Number(v)) ? Number(v) : null);

  // ---------- Storage ----------
  const KEY = 'reefChemEntries.v1';
  const load = () => { try { return JSON.parse(localStorage.getItem(KEY))||[] } catch { return [] } };
  const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

  // ---------- State ----------
  let entries = load();
  let editingId = null;
  let pendingShortcut = false;

  // ---------- DOM ----------
  const form = $('#entryForm');
  const resetBtn = $('#resetBtn');
  const saveAndNotesBtn = $('#saveAndNotesBtn');
  const exportBtn = $('#exportBtn');
  const importInput = $('#importInput');
  const clearAllBtn = $('#clearAllBtn');
  const testsDiv = $('#tests');
  const changeWaterBtn = $('#changeWaterBtn');
  const sendAllDosesBtn = $('#sendAllDosesBtn');

  // Dosing controls
  const khDose = $('#khDose');
  const caDose = $('#caDose');
  const mgDose = $('#mgDose');
  const khDoseBtn = $('#khDoseBtn');
  const caDoseBtn = $('#caDoseBtn');
  const mgDoseBtn = $('#mgDoseBtn');
  const khMinus = $('#khMinus'); const khPlus = $('#khPlus'); const khZero = $('#khZero');
  const caMinus = $('#caMinus'); const caPlus = $('#caPlus'); const caZero = $('#caZero');
  const mgMinus = $('#mgMinus'); const mgPlus = $('#mgPlus'); const mgZero = $('#mgZero');

  // NEW: other actions
  const foodSpoons = $('#foodSpoons');
  const foodMinus = $('#foodMinus'); const foodPlus = $('#foodPlus'); const foodZero = $('#foodZero');
  const foodSendBtn = $('#foodSendBtn');
  const surfaceFilmBtn = $('#surfaceFilmBtn');
  const filterFlossBtn = $('#filterFlossBtn');

  // NEW: KH reading & computed fields
  const khReadingSel = $('#khReading');
  const khDkhInput = $('#khDkh');
  const khPreview = $('#khPreview');

  // Init date
  $('#date').value = todayLocalISO();

  // ---------- iOS Shortcuts helpers ----------
  function openShortcutWithText(text){
    const shortcutName = 'SaveToReefTankData';
    const url = `shortcuts://run-shortcut?name=${encodeURIComponent(shortcutName)}&input=text&text=${encodeURIComponent(text)}`;
    window.location.href = url;
  }
  function formatEntryForNotes({date,no3,po4,kh,ca,mg,khx2}){
    const v = x => (x===undefined || x===null || x==='') ? '-' : x;
    // NOTE: Per request, do NOT include the plain KH line in the Notes payload.
    const lines = [
      `Reef Log — ${date}`,
      `NO3: ${v(no3)}`,
      `PO4: ${v(po4)}`,
      // KH omitted from Notes
      `Ca: ${v(ca)}`,
      `Mg: ${v(mg)}`
    ];
    if (khx2 !== undefined && khx2 !== null && khx2 !== ''){
      lines.push(`KH×2 (2 mL): ${khx2}`);
    }
    return lines.join('
');
  }
  function formatDMYSlash(iso){
    if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)){
      const d = new Date();
      return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    }
    const [y,m,d] = iso.split('-').map(Number);
    return `${d}/${m}/${y}`;
  }
  function formatDropletLine(label, amount){
    return `${label} droplet at ${amount}ml per day`;
  }

  // ---------- KH reading → dKH (with interpolation) ----------
  // Anchor table from Salifert card for 0.60–0.80 mL
  const KH_ANCHORS = [
    {r:0.60, dkh:6.1},
    {r:0.62, dkh:5.7},
    {r:0.64, dkh:5.4},
    {r:0.66, dkh:5.1},
    {r:0.68, dkh:4.8},
    {r:0.70, dkh:4.5},
    {r:0.72, dkh:4.1},
    {r:0.74, dkh:3.8},
    {r:0.76, dkh:3.5},
    {r:0.78, dkh:3.2},
    {r:0.80, dkh:2.8}
  ];
  function computeDkhFromReading(reading){
    reading = Number(reading);
    if(!Number.isFinite(reading)) return null;
    // Exact match first
    for(const p of KH_ANCHORS){ if(Math.abs(p.r - reading) < 1e-9) return p.dkh; }
    // Clamp to range
    if(reading <= KH_ANCHORS[0].r) return KH_ANCHORS[0].dkh;
    if(reading >= KH_ANCHORS[KH_ANCHORS.length-1].r) return KH_ANCHORS[KH_ANCHORS.length-1].dkh;
    // Find neighbors and interpolate linearly
    for(let i=0;i<KH_ANCHORS.length-1;i++){
      const a = KH_ANCHORS[i], b = KH_ANCHORS[i+1];
      if(reading > a.r && reading < b.r){
        const t = (reading - a.r) / (b.r - a.r);
        return +(a.dkh + t*(b.dkh - a.dkh)).toFixed(2);
      }
    }
    return null;
  }
  function computeKhx2(dkh){
    if(!Number.isFinite(dkh)) return null;
    return +(dkh*2).toFixed(2);
  }
  function fillKhReadingOptions(){
    if(!khReadingSel) return;
    const opts = [];
    for(let v=0.60; v<=0.80001; v+=0.01){
      const vFixed = v.toFixed(2);
      opts.push(`<option value="${vFixed}">${vFixed}</option>`);
    }
    khReadingSel.innerHTML = opts.join('');
    khReadingSel.value = '0.70'; // default
    // Seed computed values
    updateKhComputed();
  }
  function updateKhComputed(){
    const reading = Number(khReadingSel?.value ?? '');
    const dkh = computeDkhFromReading(reading);
    const khx2 = computeKhx2(dkh);
    if(khDkhInput) khDkhInput.value = Number.isFinite(dkh) ? dkh.toFixed(1) : '';
    if(khPreview) khPreview.textContent = `KH×2 (2 mL sample): ${Number.isFinite(khx2)? khx2.toFixed(1) : '—'}`;
  }

  if(khReadingSel){
    fillKhReadingOptions();
    khReadingSel.addEventListener('change', updateKhComputed);
  }

  // ---------- Submit (Save) ----------
  form.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    const dkhComputed = toNumber($('#khDkh')?.value);
    const khx2Computed = computeKhx2(dkhComputed);

    const displayEntry = {
      date: data.date || todayLocalISO(),
      no3: data.no3 || '',
      po4: data.po4 || '',
      kh: (Number.isFinite(dkhComputed)? dkhComputed.toFixed(1) : ''),
      ca: data.ca || '',
      mg: data.mg || '',
      khx2: (Number.isFinite(khx2Computed)? khx2Computed.toFixed(1) : '')
    };

    const entry = {
      id: editingId || uid(),
      date: displayEntry.date,
      no3: toNumber((data.no3||'').replace('>','')),
      po4: toNumber(data.po4),
      kh: toNumber(displayEntry.kh), // Save computed dKH
      ca: toNumber(data.ca),
      mg: toNumber(data.mg),
      no3Disp: displayEntry.no3 || null,
      po4Disp: displayEntry.po4 || null,
      khDisp: displayEntry.kh || null,
      createdAt: editingId ? (entries.find(x=>x.id===editingId)?.createdAt || Date.now()) : Date.now(),
      updatedAt: Date.now()
    };
    if(editingId){ entries = entries.map(e=> e.id===editingId ? entry : e); } else { entries.push(entry); }
    save(entries);

    if(pendingShortcut){
      pendingShortcut = false;
      const text = formatEntryForNotes(displayEntry);
      setTimeout(()=> openShortcutWithText(text), 30);
    }

    form.reset();
    $('#date').value = todayLocalISO();
    fillKhReadingOptions(); // reset to default 0.70 and recompute
    editingId = null;
    $('#saveBtn').textContent = 'Save';
  });

  if (saveAndNotesBtn) {
    saveAndNotesBtn.addEventListener('click', ()=>{ pendingShortcut = true; form.requestSubmit(); });
  }

  if (resetBtn) {
    resetBtn.addEventListener('click', ()=>{
      form.reset();
      $('#date').value = todayLocalISO();
      fillKhReadingOptions();
      editingId = null;
      $('#saveBtn').textContent = 'Save';
    });
  }

  if (clearAllBtn) {
    clearAllBtn.addEventListener('click', ()=>{
      if(confirm('Delete ALL entries?')){ entries = []; save(entries); }
    });
  }

  // ---------- Maintenance actions ----------
  if (changeWaterBtn) {
    changeWaterBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const iso = (document.getElementById('date')?.value) || todayLocalISO();
      const display = formatDMYSlash(iso);
      const text = `${display}\n#changewater`;
      openShortcutWithText(text);
    });
  }

  function fillDoseSelect(sel){
    if(!sel) return;
    sel.innerHTML = '<option value="">—</option>' + Array.from({length:31},(_,i)=>i-15).map(n=>`<option value="${n}" ${n===0?'selected':''}>${n}</option>`).join('');
  }
  [khDose, caDose, mgDose].forEach(fillDoseSelect);

  function adjustDose(sel, delta){
    if(!sel) return;
    const current = Number(sel.value || 0);
    let next = current + delta;
    next = Math.max(-15, Math.min(15, next));
    sel.value = String(next);
  }
  // Steppers
  if(khMinus) khMinus.addEventListener('click', (e)=>{ e.preventDefault(); adjustDose(khDose, -1); });
  if(khPlus)  khPlus.addEventListener('click', (e)=>{ e.preventDefault(); adjustDose(khDose,  1); });
  if(khZero)  khZero.addEventListener('click', (e)=>{ e.preventDefault(); khDose.value = '0'; });
  if(caMinus) caMinus.addEventListener('click', (e)=>{ e.preventDefault(); adjustDose(caDose, -1); });
  if(caPlus)  caPlus.addEventListener('click', (e)=>{ e.preventDefault(); adjustDose(caDose,  1); });
  if(caZero)  caZero.addEventListener('click', (e)=>{ e.preventDefault(); caDose.value = '0'; });
  if(mgMinus) mgMinus.addEventListener('click', (e)=>{ e.preventDefault(); adjustDose(mgDose, -1); });
  if(mgPlus)  mgPlus.addEventListener('click', (e)=>{ e.preventDefault(); adjustDose(mgDose,  1); });
  if(mgZero)  mgZero.addEventListener('click', (e)=>{ e.preventDefault(); mgDose.value = '0'; });

  function sendDroplet(kind, sel){
    const val = Number(sel?.value ?? '');
    const amount = Number.isFinite(val) ? val : 0;
    const iso = (document.getElementById('date')?.value) || todayLocalISO();
    const display = formatDMYSlash(iso);
    openShortcutWithText(`${display}\n${formatDropletLine(kind, amount)}`);
  }
  if(khDoseBtn) khDoseBtn.addEventListener('click', (e)=>{ e.preventDefault(); sendDroplet('KH', khDose); });
  if(caDoseBtn) caDoseBtn.addEventListener('click', (e)=>{ e.preventDefault(); sendDroplet('Ca', caDose); });
  if(mgDoseBtn) mgDoseBtn.addEventListener('click', (e)=>{ e.preventDefault(); sendDroplet('Mg', mgDose); });

  if (sendAllDosesBtn){
    sendAllDosesBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const iso = (document.getElementById('date')?.value) || todayLocalISO();
      const dmy = formatDMYSlash(iso);
      const lines = [dmy];
      const trip = [
        ['KH', Number(khDose?.value ?? 0)],
        ['Ca', Number(caDose?.value ?? 0)],
        ['Mg', Number(mgDose?.value ?? 0)]
      ];
      trip.forEach(([k,v])=>{ if(Number.isFinite(v)) lines.push(formatDropletLine(k, v)); });
      openShortcutWithText(lines.join('\n'));
    })
  }

  // ---------- NEW: Other actions logic ----------
  function fillSpoonsSelect(sel){
    if(!sel) return;
    sel.innerHTML = Array.from({length:6},(_,i)=>`<option value="${i}" ${i===1?'selected':''}>${i}</option>`).join('');
  }
  fillSpoonsSelect(foodSpoons);

  function adjustSpoons(delta){
    const cur = Number(foodSpoons?.value ?? 1);
    let next = cur + delta;
    next = Math.max(0, Math.min(5, next));
    if(foodSpoons) foodSpoons.value = String(next);
  }
  if(foodMinus) foodMinus.addEventListener('click', (e)=>{ e.preventDefault(); adjustSpoons(-1); });
  if(foodPlus)  foodPlus.addEventListener('click',  (e)=>{ e.preventDefault(); adjustSpoons( 1); });
  if(foodZero)  foodZero.addEventListener('click',  (e)=>{ e.preventDefault(); if(foodSpoons) foodSpoons.value='0'; });

  if(foodSendBtn){
    foodSendBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const n = Number(foodSpoons?.value ?? 1);
      const iso = (document.getElementById('date')?.value) || todayLocalISO();
      const dmy = formatDMYSlash(iso);
      openShortcutWithText(`${dmy}\n加魚糧 ${n} 匙`);
    });
  }

  if(surfaceFilmBtn){
    surfaceFilmBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const iso = (document.getElementById('date')?.value) || todayLocalISO();
      const dmy = formatDMYSlash(iso);
      openShortcutWithText(`${dmy}\n水面有油膜`);
    });
  }

  if(filterFlossBtn){
    filterFlossBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const iso = (document.getElementById('date')?.value) || todayLocalISO();
      const dmy = formatDMYSlash(iso);
      // 你也可以改成「換綿」
      openShortcutWithText(`${dmy}\n更換過濾棉`);
    });
  }

  // ---------- Export / Import (CSV) ----------
  function toCSV(rows){
    const header = ['date','no3','po4','kh','ca','mg','no3Disp','po4Disp','khDisp'];
    const lines = [header.join(',')];
    rows.forEach(e=>{
      lines.push([
        e.date,
        e.no3 ?? '', e.po4 ?? '', e.kh ?? '', e.ca ?? '', e.mg ?? '',
        e.no3Disp ?? '', e.po4Disp ?? '', e.khDisp ?? ''
      ].join(','));
    });
    return lines.join('\n');
  }
  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
    a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  if(exportBtn){
    exportBtn.addEventListener('click', ()=>{
      const csv = toCSV(entries);
      const stamp = new Date().toISOString().slice(0,10);
      download(`reef-chemistry-${stamp}.csv`, csv);
    });
  }
  if(importInput){
    importInput.addEventListener('change', async (ev)=>{
      const file = ev.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      const [h, ...rest] = lines;
      const cols = h.split(',').map(s=>s.trim().toLowerCase());
      const idx = Object.fromEntries(cols.map((c,i)=>[c,i]));
      const get = (parts, key) => parts[idx[key]] ?? '';
      const imported = rest.map(line=>{
        const parts = line.split(',');
        return {
          id: uid(),
          date: (get(parts,'date')||'').slice(0,10),
          no3: toNumber((get(parts,'no3')||'').replace('>','')),
          po4: toNumber(get(parts,'po4')),
          kh: toNumber(get(parts,'kh')),
          ca: toNumber(get(parts,'ca')),
          mg: toNumber(get(parts,'mg')),
          no3Disp: get(parts,'no3disp') || null,
          po4Disp: get(parts,'po4disp') || null,
          khDisp: get(parts,'khdisp') || null,
          createdAt: Date.now(),
          updatedAt: Date.now()
        }
      }).filter(e=> e.date);
      if(!imported.length){ alert('No valid rows found.'); return; }
      if(!confirm(`Import ${imported.length} rows?`)) return;
      entries = entries.concat(imported);
      save(entries);
    });
  }

  // ---------- Self tests ----------
  function runTests(){
    const results = [];
    const assert = (name, cond, msg='') => results.push({name, ok: !!cond, msg});

    // Elements exist (including new KH widgets)
    const ids = ['entryForm','date','no3','po4','khReading','khDkh','ca','mg','resetBtn','saveBtn','saveAndNotesBtn','exportBtn','importInput','clearAllBtn','changeWaterBtn','khDose','caDose','mgDose','khDoseBtn','caDoseBtn','mgDoseBtn','khMinus','khPlus','khZero','caMinus','caPlus','caZero','mgMinus','mgPlus','mgZero','sendAllDosesBtn',
      'foodSpoons','foodMinus','foodPlus','foodZero','foodSendBtn','surfaceFilmBtn','filterFlossBtn','khPreview'
    ];
    ids.forEach(id=> assert(`element #${id} exists`, !!document.getElementById(id), 'Missing DOM element'));

    // IDs are globally unique
    const allIds = [...document.querySelectorAll('[id]')].map(n=>n.id);
    const uniqueIds = new Set(allIds);
    assert('All IDs are unique', uniqueIds.size === allIds.length, `Duplicate IDs: ${allIds.filter((id,i)=> allIds.indexOf(id)!==i).join(', ')}`);

    // Shortcuts URL formed (simple)
    const okURL = (()=>{
      const name = 'SaveToReefTankData';
      const txt = 'test';
      const url = `shortcuts://run-shortcut?name=${encodeURIComponent(name)}&input=text&text=${encodeURIComponent(txt)}`;
      return url.startsWith('shortcuts://run-shortcut?');
    })();
    assert('Shortcuts URL generated', okURL);

    // D/M/YYYY formatting
    const dmy = formatDMYSlash('2025-09-23');
    assert('formatDMYSlash => 23/9/2025', dmy === '23/9/2025', dmy);

    // Interpolation test at 0.61 → 5.90 dKH (linear between 0.60:6.1 and 0.62:5.7)
    const dkh061 = computeDkhFromReading(0.61);
    assert('0.61 mL → ~5.90 dKH', Math.abs(dkh061 - 5.90) < 1e-6, dkh061);

    // KH×2 preview
    const khx2 = computeKhx2(4.8);
    assert('KH×2 from 4.8 = 9.6', Math.abs(khx2 - 9.6) < 1e-9, khx2);

    if(testsDiv){
      testsDiv.innerHTML = '<ul>'+results.map(r=>`<li class="${r.ok?'dev-pass':'dev-fail'}">${r.ok?'✓':'✗'} ${r.name}${r.msg?` — ${r.msg}`:''}</li>`).join('')+'</ul>';
    }
    console.table(results);
    return results.every(r=>r.ok);
  }

  runTests();
  </script>
</body>
</html>
